# Chapter 06 캐시 최적화

## 6.1 캐시

- 콘텐츠 요청에 빠르게 응답하기 위해 서버와 클라이언트 사이에서 응답 콘텐츠의 사본을 저장하는 공간을 **캐시**라 하고, 이 캐시를 유지하고 처리해주는 별도의 서버를 **캐시 서버**라고 한다.

## 6.2 웹 캐시 동작 원리

- 캐시 서버는 HTTP/1.1 규격을 기반으로 동작한다.

### 6.2.1 HTTP

- HTTP는 인터넷에서 데이터를 주고받기 위한 클라이언트/서버 모델을 따르는 프로토콜이다.
- OSI 7계층 모델의 마지막 7계층인 Application 레벨의 프로토콜이며 TCP/IP 위에서 동작한다.

### 6.2.2 HTTP의 캐시 제어 방식

- HTTP/1.0까지는 캐시를 제어하는 명시적 기술이 없었다.

- HTTP/1.1부터 명시적으로 캐시를 제어할 수 있는 헤더를 추가했는데 이것이 Cache-Control 헤더이다.
- HTTP/1.1에서는 캐시를 제어하는 목적을 크게 두 가지로 정의한다.
  - 원본 서버로의 요청 수를 최소화한다. 이는 네트워크 왕복 수를 줄여 결과적으로 사용자 요청에 대한 응답 속도를 단축할 수 있다.
  - 완전한 콘텐츠를 응답하지 않아도 된다. 이는 네트워크 대역폭과 리소스 낭비를 줄이고 비용을 효율화한다.

### 6.2.3 캐시 유효성 체크

- 비효율적인 요청/응답을 방지하고자 HTTP 표준은 조건부 요청이라는 메커니즘을 정의한다.
- 이 메커니즘은 저장된 응답 TTL이 만료되었을 경우 캐시가 항상 원본 서버에서 완전한 콘텐츠를 받아오는 대신 TTL 주기 동안 콘텐츠에 변화가 있을 때에만 새 응답을 만들도록 요청한다.
- 원본 서버에서 조건부 요청을 받았다면 해당 콘텐츠에 변경이 있을 때 200 응답 코드와 함께 변경된 콘텐츠를 응답 본문에 포함해 보낸다. 대신 변경이 없다면 응답 본문 없이 304코드만 헤더에 설정하여 보내는데 응답에 본문이 없으므로 서버와 네트워크 자원 낭비를 방지할 수 있다.

### 6.2.4 캐시 콘텐츠 갱신

- 캐시에 저장된 내용을 갱신하기 위해서 아래 두 가지 방법을 사용할 수 있다.

  - 퍼지(purge)

    - 저장소를 완전히 지우는 방식, 대부분의 캐시 서버가 캐시를 모두 지우는 명령이나 API를 제공한다.
    - CDN을 비롯한 캐시 서버에서 한꺼번에 많은 콘텐츠를 퍼지하려면 원본 서버에 충분한 자원이 있는지 확인하는 등 주의를 기울여야한다.

  - 무효화(invalidate)

    - 캐시 저장소를 완전히 지우기보다 조건부 요청을 통해 캐시된 리소스들 중 변경이 있었던 리소스들만 새로 갱신하는 방식

    - 아래처럼 Cache-Control 헤더를 사용해 캐시 서버의 내용을 강제로 무효화할 수 있다.

      > Chche-control: max-age=0, must-revalidate



## 6.3 캐시 최적화 방안

- 캐시 사용을 최대화할 수 있는 3가지 기본 원리
  - 최대한 많이 캐시하라
  - 최대한 오래 캐시하라
  - 최대한 가까이 캐시하라



### 6.3.1 캐시 가능한 콘텐츠 구분하기

- WebPageTest를 통해 얼마나 많은 파일을 캐시할 수 있는지 확인 가능

### 6.3.2 올바른 캐시 정책 설정하기

1. 캐시할 수 있는 콘텐츠인지 판단
2. 캐시할 수 있는 콘텐츠들은 매번 원본 서버에 변경 사항을 확인해야 하는지 판단.
3. 캐시할 콘텐츠들의 성격을 판단.
4. 캐시 주기를 설정하고 max-age를 추가

### 6.3.3 캐시 주기 결정하기

1. 캐시 주기는 콘텐츠 타입별로 다르게 설정할 수 있다.
2. 링크 변경 없이 이미지 내용만 바꿔야 한다면 캐시 무효화 방식으로 해당 이미지만 캐시에 업데이트 한다.
3. 모든 정적 파일에 대해 캐시 주기를 길게 설정하고 수동으로 캐시 주기를 관리하는 방법도 있다.

### 6.3.4 캐시에 적합한 디렉터리 구조 구성하기

1. 캐시할 수 있는 콘텐츠들을 별도의 폴더에 분류해 관리한다.

2. 캐시 주기별로 나누어 구성한다.

3. 세 번째로 동일한 파일을 여러 곳에 분산시키지 않아야 한다.

### 6.3.5 캐시 키 올바르게 사용하기

### 6.3.6 CDN 사용하기

## 6.4 동적 콘텐츠 캐시

## 6.5 고급 캐시 전략

