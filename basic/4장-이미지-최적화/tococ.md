# Chapter 04 이미지 최적화

## 4.1 이미지의 중요성

- 직관을 중요시하는 우리나라 사용자 특성을 고려하여 많은 웹 사이트에서는 화려하고 선명한 이미지를 사용해 홈페이지를 꾸미는데 노력하고 있다.
- 인터넷 초창기에는 1K 이상 크기의 이미지를 홈페이지에 올리는 것을 상상하기 어려웠지만 현재는 초고속 인터넷 시대에 접어들어 이미지의 크기가 점점 더 커지고 있는 추세이다.
- 통계 자료를 살펴보면, 이미지 개수는 48개에서 56개로 17%증가했지만 이미지 크기는 419KB에서 1,854KB로 무려 340%나 증가한 것을 알 수 있다.

<br>

**화소 밀도**

- 화소 밀도란 물리 스크린 공간 안에 얼마나 많은 픽셀이 압축되어 있는가를 의미한다.
- 화소 밀도는 1x, 2x와 같은 기기 픽셀 비율로 표현하고 이것은 단위 길이 안에 존재하는 픽셀의 개수를 상대적으로 나타내는 단위이다.
- 같은 1인치 안에 픽셀 수가 많으면 많을수록 화소 밀도가 높으며, 화소 밀도가 높을수록 더 선명한 화면을 표현할 수 있다.
- 40픽셀 이미지는 말 그대로 40픽셀의 너비를 가진 이미지 하나를 의미한다. 그러나 40포인트 이미지는 1x에서는 40픽셀, 2x에서는 80픽셀, 3x에서는 120픽셀의 너비를 가진 이미지를 뜻한다.
  - 따라서, 웹 디자이너가 하나의 이미지를 사용할 때 디스플레이를 고려해 여러 크기의 이미지들을 모두 준비해야한다.

<br>

- 이러한 이미지의 특성은 웹 사이트의 성능에서 가장 중요한 역할을 한다.
- 예를 들어, 비즈니스 부서에서는 구매자의 눈길을 끌기 위해 크고 선명하고 화려한 이미지들을 사용하도록 요구하는 반면 디자이너가 만든 고품질 이미지를 그대로 사용하면 웹 성능 문제로 고객 불만이 발생할 수 있기 때문이다.

<br>

## 4.2 디지털 이미지의 종류와 특성

- 이미지를 잘 사용하려면 우선 이미지의 종류와 특성을 잘 파악해야한다. 즉, 사용될 기기 타입과 용도에 맞춰 적절한 이미지를 선택해야한다.
  - 예를 들어, 모바일 이미지에 PNG 타입을 사용하고 있지만 투명 기능이 필요하지 않다면 JEPG 타입으로 변환해 사용하는 것이 더 작은 크기의 이미지를 사용할 수 있는 방법이다.

- KissMetric의 연구 결과에 따르면 페이지 로딩 시간이 1초 느려질 경우 상품을 구매하는 사용자의 비율이 약 7% 감소할 수 있다고 언급되는 것처럼 이미지 형식의 종류와 특징을 잘 파악하고 사용 목적 및 기기에 맞는 이미지를 선택하는 것이 웹 성능 향상뿐만 아니라 비즈니스에 도움이 되는 것을 알 수 있다.

<br>

### 4.2.1 래스터 이미지 vs 벡터 이미지

- 디지털 이미지는 일반적으로 디지털 화면에 이미지들을 어떻게 표현하는지에 따라 레스터 이미지와 벡터 이미지로 분류된다.



**레스터 이미지**

- 레스터 이미지는 우리가 사용하는 대부분의 이미지 유형이다.
- 작은 사각형 모양의 픽셀에 표현하고자 하는 색상 정보를 입력해 이를 컴퓨터로 표현하는 방식이다.
- 또한 각각의 픽셀들이 모여 하나의 큰 이미지를 완성하기 때문에 사이즈가 크거나 품질이 더 좋은 이미지를 만들기 위해서는 그만큼의 정보를 담은 픽셀들을 추가해야만 컴퓨터가 이를 정상적으로 표현할 수 있다.

<br>

**벡터 이미지**

- 벡터 이미지는 그리고자 하는 대상의 수학적인 정보를 제공한다.
- 벡터이미지는 메타 정보를 담고 있으므로 화면이 커지거나 작아진다고 해서 이 정보가 달라지지 않기 때문에 화면 스케일에 상관없이 항상 선명한 이미지를 표현할 수 있다.
- 단, 그림이 복잡해지면 이를 표현하기 위한 정보가 기하급수적으로 늘어나며 이를 수학적인 정보로 표현하는 데에도 많은 제약이 있다.
- SVG 파일은 텍스트 기반 콘텐츠이므로 gzip이나 brotli 같은 텍스트 압축 기법으로 간단히 최적화할 수 있다.

<br>

### 4.2.2 무손실 이미지 형식 vs 손실 이미지 형식

- 이미지 형식을 구분하는 또 다른 기준은 이미지 정보의 손실을 허용하는 지 여부이다.
- 원본 이미지의 정보 손실을 원하지 않으면 무손실 이미지라고 하고 필요에 따라 이동할 수 있는 형태를 만들기 위해 정보 손실을 어느 정도 허용하면 손실이미지라고 한다. 
- GIF, PNG는 무손실 이미지의 대표적 형식이다.

<br>

**GIF**

- GIF는 인터넷이 활성화된 이래 가장 처음으로 등장한 이동식 이밎 형식으로써 현재까지도 널리 사용되고 있다.
- 사용할 수 있는 색이 256로 매우 제한적이다.
- 화려한 색상의 복잡한 이미지보다 기업의 로고 같은 다소 단순한 형태의 이미지 표현에 적합하다.

<br>

**PNG**

- PNG는 256색만 사용할 수 있는 GIF의 단점과 특허 문제를 해결하기 위해 개발되었다.
- 24비트 색상을 사용하므로 GIF보다 고품질 이미지를 표현할 수 있다.
- 컬러 팔레트 PNG와 트루 컬러 PNG로 나눌 수 있는데 대부분 웹 사이트에서 사용되는 PNG는 알파 채널이 추가된 트루 컬러 PNG이다.

<br>

**JPEG**

- JPEG는 사진을 저장하는 사실상의 표준 형식이다.
- JPEG는 사람의 눈이 인식할 수 있는 색상만 남기고 나머지를 제거하는 방식의 기술을 사용하여 이미지를 표시하는 데 필요한 정보를 줄인다. 그렇기 때문에 고해상도 이미지를 크게 압축한 파일로 저장할 수 있다.
- JPEG는 사용자가 그 품질 값을 결정할 수 있다.
- PNG 파일보다 크기가 훨씬 작지만 투명 기능이나 애니메이션 기능을 지원하지 않는다.

<br>

**JPEG 2000**

- JPEG 2000은 JPEG의 단점을 보완하려고 새롭게 개발한 이미지 형식이다.
- JPEG의 압축 방식과 달리 새로운 방식을 사용하여 이미지 압축률을 높였다.
- 무손실 압축 및 투명 기능, 애니메이션 기능을 지원하고 16, 24, 32비트 등 다양한 색상을 지원한다.
- 그러나 다양한 기능이 포함된 만큼 다른 형식들에 비해 더 많은 프로세싱 자원이 필요하다.
- 대부분의 브라우저에서 지원하지 않는다.

<br>

**WebP**

- WebP는 구글에서 개발하고 배포한 이미지 형식이다.
- JPEG보다 개선된 공격적 압축 방식을 사용하여 파일 크기를 25% ~ 35% 정도 작게 만들 수 있다.
- 무손실 압축, 애니메이션 기능을 지원한다.
- WebP는 다른 이미지 형식들에 비해 압축률이 높지만 이미지 품질을 많이 낮추면 화질에 약간의 손실이 발생한다.

<br>

**JPEG XR**

- JPEG XR은 마이크로소프트사에서 개발한 이미지 형식이다.
- JPEG에 비해 R/G/B에 해당하는 색상 채널당 더 많은 수의 채색을 허용해서 표현할 수 있는 색상 범위를 확장했다.
- 무손실 압축 및 투명 기능을 지원한다.
- 점진적 데이터 전송 기능도 지원한다.
- 향상된 압축 기법으로 파일 크기를 크게 감소시킬 수 있다.
- 단, 인터넷 익스플로러와 에지에서만 지원한다.

<br>

## 4.3 이미지 변환 기법

- 이미지를 변환하는 주된 이유는 이미지 파일의 크기를 줄이기 위함이다.

<br>

### 4.3.1 무손실 압축

- 무손실 압축을 하려면 각 이미지 유형을 다르게 처리해야한다.
- 스크립트를 통해 압축을 자동화할 수 있다는 장점이 있다.

<br>

**GIF**

- 애니메이션이 포함되어 있지 않다면 압축률이 더 높은 PNG8이나 각 브라우저에 특화된 이미지 형식으로 변경하는 것을 권한다.
- ImageMagicK, Giflossy, Gifsicle, gif2webp converter, ImageMagicK를 활용하여 GIF와 관련된 작업을 진행할 수 있다.

<br>

**PNG**

- PNG임을 알리는 구분자인 첫 8바이트의 서명을 제외하고 청크 형태로 이미지 정보를 저장한다.
- 이미지 정보를 저장하는 것은 핵심 청크이다.
- 정보성 청크 등 사용자 정의 청크를 추가할 수도 있지만 이러한 청크들은 대부분 웹 렌더링에 필요하지 않으므로 삭제할 수 있다.

- PngCrush,  Pngquant라는 도구를 활용하여 PNG와 관련된 작업을 진행할 수 있다.

<br>

**JPEG**

- JPEG 파일 안에는 이미지 정보 외에도 많은 메타 데이터가 포함되어 있다.
  - 주석 및 공백
  - 어도비 포토샾 같은 편집 애플리케이션 정보
  - 카메라 제조사 및 모델, 사진 촬영 날짜등
- 위의 정보들은 이미지를 표시할 때 아무 도움이 되지 않기 때문에 제거해도 이미지 품질 손실 없이 파일 크기를 줄일 수 있다.

- MozJPEG, libJpeg, Guetzli라는 도구를 활용하여 JPEG와 관련된 작업을 진행할 수 있다.

<br>

### 4.3.2 손실 압축

- 손실 압축은 특정 이미지 정보를 누락, 즉 손실시켜 파일 크기를 줄이는 방법이다.
  - 예를 들어, 사람의 시각은 명암 차이에 민감하지만 채색 차이에 크게 민감하지 않는다. 따라서 이미지 색이 비슷한 부분을 하나의 색으로 통일해 그만큼의 정보를 손실시켜도 사용자는 눈치채지 못한다.
- 손실 압축은 원하는 만큼의 화질을 얻지 못하는 위험이 있으므로 고화질의 사진을 저장해 감사하고 싶다면 손실 압축을 피해야한다.
- 손실 압축 기법을 잘 활용하면 사용자의 시각적 경험은 훼손하지 않으면서도 로딩 속도를 눈에 띄게 향상시킬 수 있다.
- 손실 압축을 하려면 기존 이미지 형식을 디코딩한 후 알고리즘에 따라 원하는 화질로 저하시켜 다시 원래 이미지 형식으로 인코딩해야 한다.

<br>

**적절한 손실 압축 품질 지수**

- 사용자의 경험을 해치지 않고 파일 크기를 크게 줄일 수 있는 손실 압축 품질 수준은 각 이미지 특성에 따라 최적의 품질 수준이 달라진다.
- 손실 압축을 위한 최적의 품질 지수를 찾기 위해서는 원본 이미지와 손실 압축 이미지의 시각적 차이를 정량 계산할 수 있는 방법이 필요하다.

- 평균 제곱 오차, 최대 신호 대 잡음 비, 구조적 유사도를 활용해서 두 이미지 간 차이를 정량적으로 수치화해 표현하려는 연구가 계속 진행되고 있다.

<br>

**시각적 인지 능력을 고려한 자동 최적화 도구**

- 여러 알고리즘을 사용해 사람이 인지하지 못할 정도의 이미지 최적화를 수행하는 것은 쉽지 않다.
- 또한, 웹 사이트 내 모든 이미지 파일에 적용하려면 일련의 작업을 자동화해야한다.
- Akami 같은 CDN 서비스 제공 업체에서는 이미지 트래픽 관련 자동 최적화 기능을 제공한다.
  - 개별 사용자의 화면 크기, DPI등의 정보를 고려하여 각각 적절한 수준으로 손실 압축을 수행하고 사용 브라우저에 적합한 이미지 형태로 변환해 전송한다.

<br>

**브라우저 특화 이미지로 변환**

- 모든 사용자의 웹 경험을 향상시키려면 하나의 이미지를 만들더라도 다양한 브라우저 특화 이미지 형태로 변환시켜 제공해야한다.
- WebP와 JPEG2000 같은 도구는 위와 같은 수고를 덜어주는 형태별 이미지 변환 도구이다.

<br>

## 4.4 반응형 웹에서의 이미지 배치 전략

- 반응형 웹이란 TV, PC, 태블릿, 스마트폰 등 각종 기기가 제공하는 화면 크기에 맞추어 최적화된 웹 페이지를 제공하는 것을 말한다.
- 반응형 웹을 사용하면 동일한 웹 사이트가 각 기기 화면에 최적화된 구조로 변경되어 제공된다.
- 반응형 웹을 사용하면 기기별로 웹 사이트를 구축하지 않아도 되므로 유지 보수의 필요성도 없어지고 모바일 사용자의 사용성도 개선되는 장점이 있다.

<br>

###  4.4.1 반응형 웹의 문제점

- 하지만, 성능 측면에서 효과적이지 못하다는 단점이 존재한다. (웹 페이지의 무게는 반응적이기 못했기 때문)
- 모바일 환경은 데스크톰 환경에 비해 열악하여 페이지 로딩 시간이 느려진다.
- 또한, 데스크톱에 비해 모바일 기기의 GPU, 메모리 등의 사양이 좋지 않아 모바일 환경에서 페이지 로딩 시간은 더 길어질 것이다.
- 결국 모바일 사용자를 위해 도입된 반응형 웹이 오히려 성능 저하로 인해 사용자 경험의 질을 저하시키는 모순이 발생한다.

<br>

### 4.4.2 원인은 이미지

- 화면의 크기나 사용하는 기기가 바뀌어도 웹 사이트의 무게가 변하지 않는 다는 것이 반응형 웹의 문제였는데, 이 문제의 원인은 바로 사용자의 웹 환경에 따라 변하지 않는 이미지의 크기다.
- 개발자들은 테스크톱이나 모바일 환경에서 모두 이미지를 제대로 보여줘야하기 때문에 데스크톱에 맞춘 이미지를 준비하는 게 대부분이다. 이러한 상황에서 사용자의 기기 화면이 작아졌다고 해서 웹 사이트의 무게가 달라지지 않는다.
- 화면이 작아졌는데도 필요 이상의 웹 리소스들을 과하게 내려받는 현상은 아래 세 가지 유형으로 구분될 수 있다.
  - 내려받아 줄이기
  - 내려받아 숨기기
  - 화면 바깥 부분

<br>
**내려받아 줄이기**

- 화면의 이미지 크기가 작아진다고 해서 실제 이미지가 작아지지 않기 때문에 브라우저가 큰 이미지를 다운로드해 작게 축소하는 처리가 진행된다.
- 이때 가로 x 세로 값이 명시되지 않기 때문에 실시간으로 이 값을 계산하는 추가 과정이 필요하다.
- 결국 모바일 환경에서는 과도하게 큰 이미지를 다운로드하려고 네트워크를 낭비하게 되는 문제가 발생한다.

<br>

**내려받아 숨기기**

- 모바일 화면에 비해 데스크톱 화면의 크기는 훨씬 크기때문에 데스크톱 하면에는 비즈니스를 위해 더 많은 정보를 나타내는 것이 유리하다.
  - 바꿔 말하면 데스크톱 화면에는 모바일 화면에서는 불필요한 리소스들이 존재한다는 의미이다.

- 모바일에는 필요없는 정보들을 숨기기 위해 CSS를 활용해서 숨기기 처리를 해주는 경우가 있다. 하지만, 브라우저는 CSS에 의해 숨겨진 이미지들도 모두 다운로드해 필요 이상으로 네트워크 자원을 소모하면서 로딩 시간을 지연시킨다.

<br>

**화면 바깥 부분**

- 화면 바깥 부분의 이미지들은 화면에 보이지 않지만 내려받아 숨기기처럼 모두 다운로드된다.
- 만약 화면 바깥쪽 이미지들을 다운로드하기 위해 너무 오랜 시간이 허비된다면 전체 페이지의 로딩 시간이 늦어지고, 화면 안쪽 부분의 로딩 시간에도 영향을 준다.

<br>

### 4.4.3 반응형 이미지

- 이러한 이미지 관련된 문제들을 해결하기 위해서는 사용자의 환경에 따라 그 환경에 적합한 이미지를 전송하면 된다.
- 사용자가 특정 환경에서 특정 이미지를 요청하면 그 환경에 맞도록 이미 변경된 이미지가 전송되는 것이 반응형 이미지다.
  - 이를 통해, 앞에서 살펴본 과도한 이미지 다운로드 문제를 방지할 수 있다.

<br>

### 4.4.4 반응형 이미지 구현 방법

- 반응형 이미지 구현은 프런트엔드와 백엔드 측면에서 구현될 수 있다.
- 프론트엔드 측면에서의 구현은 미디어 쿼리를 사용해 클라이언트 환경을 파악한 후 그 환경에 맞는 이미지 파일을 호출하도록 웹 페이지를 구현하는 방법이다.

<br>

**srcset과 size 속성**

- srcset은 HTML의 img 태그 속성으로 사용자의 다양한 환경에 따라 다른 이미지 URL을 지정할 수 있도록한다.
- srcset은 브라우저에 가장 적절한 이미지를 선택하도록 힌트를 주는 역할을 한다.
- srcset은 내려받아 줄이기 문제를 어느 정도 해결해 주지만 이를 완벽하게 지원하진 않는다.

<br>

**picture 태그**

- picture 태그는 앞서 설명한 img srcset의 단점을 모두 보완한다. 또한 내부적으로 source 태그를 사용해 다양한 이미지 URL을 설정하게 한다.
- 이때, 미디어 쿼리를 사용해 각 URL의 로딩 조건을 구체적으로 정의할 수 있다.
- srcset과는 다르게 정의된 조건에 맞는 이미지만 사용하도록 브라우저를 강제할 수 있으면 조건에 맞지 않는 이미지는 다운로드하지 않는다. 
  - 따라서 내려받아 숨기기와 내려받아 줄이기 문제를 모두 해결하는 가장 효과적인 방법이다.
- 하지만, 모든 브라우저가 이 태그를 지원하지 않는다는 단점이 있다.

<br>

**Art direction**

- srcset과 picture를 사용해도 해결되지 않는 문제인 반응형 이미지가 사용자 환경에 따라 자동으로 변하지 않는 문제를 해결하기 위한 방법이 Art direction이다.
- Art direction은 같은 이미지를 크기만 다르게 하는 것이 아니라 이미지의 특징이나 가치가 기기 특성에 따라 표현되도록 정교한 작업을 진행하는 것이다.

- Art direction을 적용하려면 개발 및 운영에 많은 시간과 비용이 요구된다는 단점이 있다.

<br>

**Client Hints**

- picture 태그, srcset 속성과는 전혀 다른 접근법을 제공한다.
- 웹 페이지를 호스팅하는 서버에서 사용자 환경을 고려해 응답할 내용을 최적화한 후 브라우저에 전달하는 방안이 도입되고 있는데 이때 사용자 환경을 서버에 표준 방식으로 전달하기 위해 Client Hints를 사용하도록 논의되고 있다.

<br>

**이미지 지연 로딩**

- 나타내지 않을 이미지를 처음부터 다운로드하는 것은 웹 성능을 저하시킨다.
- 해당 문제를 해결하기 위해서 자바스크립트를 사용한 지연 로딩 방법이  존재한다.
  - 사용자들에게 노출될 수 있는 상태일때만 해당 이미지를 다운로드하는 방법이라고 이해하면 된다.

<br>
**모바일 우선 접근**

- 모바일 우선이란 모바일 기기에 적합한 페이지부터 개발하는 방법이다.
- 모바일 사용자가 데스크톱 사용자를 넘어섰고 앞으로도 더 증가할 추세라면 모바일 우선 접근법을 사용하는 것도 모바일 페이지 성능을 개선하는 방법이 될 수 있다.

<br>

## 4.5 적응형 이미지 전략

- 앞에서는 반응형 웹의 문제점과 클라이언트 사이드인 웹 브라우저에서 이를 해결하는 방법을 설명했다.
- 하지만 해당 방법을 사용하게 되면 어떠한 상황에서는 하나의 이미지를 다운로드하기 위한 코드가 늘어나고 이미지가 많아질수록 웹 페이지의 크기가 커지는 문제가 발생할 수 있다.
- 이를 해결하고자 서버 측 반응형 웹 접근 방법이 등장하게 되었다.

<br>

### 4.5.1 적응형 이미지 아키텍처

- 적응형 이미지 아키텍처는 다음 두 부분에서 기존 웹 아키텍처와 다르다.
  - 요청 클라이언트 정보를 감지
  - 클라이언트 맞춤형 데이터를 로딩하는 서버 로직 추가
- 적응형 이미지 아키텍처에서 가장 근본적이고 중요한 부분은 클라이언트의 정보를 어떻게 감지하느냐이다.
  - 서버 측 반응형 웹에서는 HTTP 요청 정보 외에 클라이언트의 정보를 알 길이 없기 때문이다.
  - HTTP 요청의 User-Agent 헤더를 통해 클라이언트의 정보를 알 수 있다.

<br>

### 4.5.2 기기 정보에 따라 서버 로직 수행

- 클라이언트의 정보를 통해 기기와 관련된 정보들을 수집했다면 클라이언트 환경에 맞는 이미지 파일을 링크에 연결한다.

<br>

### 4.5.3 브라우저별 이미지 전달

- 브라우저별 이미지는 HTTP 요청의 Accept 헤더를 참고해 결정할 수 있다.

<br>

### 4.5.4 캐시 고려 사항

- 서버 측 반응형 웹이나 이에 따른 적응형 이미지를 구성할 때 성능을 고려해 이미지를 캐시하는 경우가 많다.
- 적응형 이미지는 동일한 URL을 사용해도 사용자 기기에 따라 서로 다른 이미지가 응답될 수 있으므로 이에 따른 캐시 충돌 현상에 주의해야한다.
- 캐시 충돌 현상은 하나의 URL에 여러 개의 다른 콘텐츠가 응답할 수 있을 때 먼저 응답하는 콘텐츠만 캐시되는 현상이다.
- 이러한 현상을 피하려면 서버에서 응답할 때 Vary 헤더를 활용해서 특정 헤더에 따라 콘텐츠가 달라질 것이라고 캐시 서버에 알려줘야한다.
