# Chapter 05 웹에서 가속을 이끌어 내는 방법

## 5.1 웹 브라우저 현황 알아보기

프런트엔드 최적화의 핵심 : 브라우저가 페이지를 화면에 렌더링하는 방식을 이해하고 이를 최적화하는 것

## 5.2 웹 브라우저 동작 이해하기

1. 브라우저는 도메인 서버와 통신하여 접속하려는 호스트의 IP를 찾는다
2. 해당 아이피를 가진 서버와 통신을 시도해 TCP 연결을 맺는다
3. HTTPS에선 암호화된 연결을 생성하려는 협의 단계가 더 추가된다
4. 이후 연결이 맺어지면 브라우저는 서버로부터 필요한 리소스들을 다운로드해 이를 화면에 표현한다



- 브라우저 리소스 다운로드 과정

  방문페이지(landing page)의 HTML을 서버에 요청해 다운로드한다. 

  HTML의 구문을 분석(parsing)하며 HTML 태그에 참조된 CSS, JavaScript, Image, font등 하위 리소스들을 차례로 다운로드함

### 5.2.1 브라우저 아키텍처

1. 유저 인터페이스

2. 브라우저 엔진

3. 렌더링 엔진

4. 네트워킹

5. UI 백엔드

6. 자바스크립트 해석기

7. 데이터 저장소

   ![브라우저 레퍼런스 아키텍처](https://user-images.githubusercontent.com/48556400/148060008-2d37d58e-62b6-4793-a700-ded9b48f2f45.jpg)

### 5.2.2 중요 렌더링 경로

렌더링 엔진이 웹 페이지를 구문 분석해 화면에 표현하는 일련의 작업은 단일 스레드에 의해 수행됨

![0_A24XmmK2IUz0wvkg](https://user-images.githubusercontent.com/48556400/148215881-043d3233-e76c-473c-8b3f-72ea6cfe47d9.png)

1. 브라우저는 HTML을 가장 처음 구문 분석하며 DOM 트리를 만듬
2. CSS를 구문 분석하여 CSSOM 트리를 만듬
3. 두 개의 트리 모델을 결합해 최종적으로 렌더 트리를 만듬
4. 렌더 트리가 생성되면 브라우저는 이를 기반으로 페이지 구조를 결정하고 화면에 표현

## 5.3 브라우저 렌더링 최적화하기

### 5.3.1 DOM 최적화하기

- HTML의 구문 오류를 최소화하는 것이 가장 기본적이고 간단한 방법

  HTML을 DOM으로 전환하는 과정은 구문 분석이 관대하다는 점에서 XML과 다름

  HTML은 구문 체크에 관대하므로 작성 시 문법 오류가 발생해도 브러우저에는 정상적으로 표현되는 경우가 많음

  웹 페이지 내에 오류가 많을수록 브라우저는 예외처리를 위해 더 많은 메모리와 CPU 파워를 소모함

- 과도하게 HTML 태그를 중첩하는 행위를 피할 것

  자바스크립트에 의해 스타일이 변경될 때 각 태그의 레이아웃을 다시 계산하고 재구성하는데 더 많은 리소스와 시간이 소요됨

  일반적으로 중첩된 태그가 15단계를 넘지 않도록 권장

- DOM을 분석해 최적화 방안을 알려주는 무료 도구 DOM Monster 

### 5.3.2 자바스크립트와 CSS 배치하기

- CSS와 자바스크립트의 렌더링 방해를 피하려면 CSS를 최대한 소스 위쪽에 배치하여 CSSOM이 빨리 생성되도록 한다

### 5.3.3 자바스크립트 최적화하기

- 자바스크립트가 전체 페이지 로딩 시간에 영향을 주는 것을 막기 위해, 자바스크립트 수행이 렌더링 스레드를 방해하지 않도록 별도 스레드로 자바스크립트를 수행시켜야함

- 렌더링 작업이 어느 정도 끝난 이후 스크립트를 수행해야함

- async와 defer 속성을 사용하기

  async : HTML 구문 분석과 동시에 자바스크립트를 다운로드하고 수행. 지연 수행시 스크립트간 선후 관계를 따지지 않음

  defer : 구문 분석 중에 별도의 스레드로 자바스크립트를 다운로드하고 구문 분석이 끝난 이후에 수행. 스크립트가 호출된 순서에 따라 차례로 수행

  참고 : [모던 자바스크립트 Deep Dive 38장 브라우저의 렌더링 과정](https://github.com/Frontend-Divers/modern-javascript-deep-dive/tree/master/38%EC%9E%A5-%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80%EC%9D%98-%EB%A0%8C%EB%8D%94%EB%A7%81-%EA%B3%BC%EC%A0%95#async-%EC%96%B4%ED%8A%B8%EB%A6%AC%EB%B7%B0%ED%8A%B8)

- 주의 : 모든 자바스크립트가 비동기나 지연 처리의 대상이 될 수 없다

- 브라우저가 페이지 로딩을 명시적으로 끝낸 후 나머지 스크립트를 수행하는 것이 확실한 방법

### 5.3.4 CSS 최적화하기

브라우저는 CSS가 구문 분석되고 CSSOM이 만들어지기까지 렌더링을 멈추므로 CSS는 렌더링 순위가 가장 높으면서 동시에 렌더링을 가장 방해하는 리소스

CSS는 필요한 정보만 빠르게 다운로드하고 실행해야 브라우저 렌더링을 가속시킬 수 있다.

- 미디어 쿼리 활용

### 5.3.5 이미지 로딩 최적화하기

- display none 속성을 사용해, 이미지가 숨겨질 것을 미리 알도록 함

  그러나 DOM과 CSSOM이 별도 분석되고 생성되기에 브라우저는 이를 미리 알지 못하고 DOM 트리에 나타난 객체들을 모두 다운로드함

- 화면 렌더링에 필요하지 않은 이미지를 다운로드 하지 않으려면 

  1. 웹사이트의 주요 이미지가 아니라면 CSS의 background-image 속성을 사용
  2. 자바스크립트를 이용한 지연 로딩 방식을 적용
  3. Progressive JPG 사용

- 주의 : 이미지 지연 로딩이 브라우저 로딩 속도 개선에 효과적일 수 있으나 사용자 경험 개선에 항상 도움이 되진 않음. 모든 이미지에 지연 로딩을 적용하면 브라우저의 프리로더가 이미지를 다운로드할 수 없기에 오히려 성능을 저해함.

  즉, 지연 로딩은 첫화면에 등장하지 않거나 숨겨진 이미지들을 다운로드하는데에만 사용

## 5.4 도메인 분할 기법 이용하기

여러 도메인을 소유한 경우 웹 콘텐츠를 병렬적으로 동시에 다운로드할 수 있도록

HTTP/1.1 프로토콜 하에서 동일 도메인에 순차적 다운로드 방식을 사용

### 5.4.1 도메인 분할 기법과 HTTP/2

## 5.5 사용자 경험 개선하기

### 5.5.1 사용자 경험 지표 바로 알기

### 5.5.2 사용자 요청에 빠르게 반응하기

### 5.5.3 사용자 시선 붙잡기

### 5.5.4 사용자 상호 작용 방해하지 않기