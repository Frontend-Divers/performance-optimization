# 3장 웹 사이트 성능을 개선하는 기본적인 방법

## 3.1 HTTP 요청 수 줄이기

- 웹 클라이언트가 특정 웹 페이지에 접속시 서버와 통신하는 방법을 알아야한다. 

  브라우저는 DNS시스템으로 특정 도메인의 접속 IP를 알아내 접속

  HTML파일을 응답 받음

  HTML내 CSS,JavaScript,이미지 등 콘텐츠를 차례로 호출

  브라우저가 HTML을 모두 해석하여 콘첸트를 전부 받아오기까지 호출이 계속 진행됨.

  만약 HTML을 받아온 도메인과 콘텐츠 주소가 다르면 DNS 조회부터 다시 시작. 이렇게 조회된 웹 서버  IP를 통해, 브라우저와 웹 서버 간 TCP/IP연결을 맺은 후 실제 콘텐츠를 다운로드함. 

- **웹 페이지를 단순하게 제작**하는 것이 HTTP 요청수를 줄이는 가장 쉬운 방법이다.

  그러나 웹을 통해 기업을 홍보하거나 제품을 판매하는 경우(유저을 끌어들이는)

  웹 성능을 위해 콘텐츠를 줄이는 게 현실적으로 적절하진 않다. 

  **즉, 콘텐츠는 동일하게 유지하되 HTTP 요청 수를 줄이는 방법을 찾아야한다.** 
 
  아래에서 살펴보자  

### 3.1.1 스크립트 파일 병합

모듈화 : 최소 기능 단위별로 SW 모듈을 나누어 개발

JavaScript나 CSS파일을 기능별로 분리하여 각각의 파일로 저장하고 호출하는 방식을 사용함

그러나 분할정복 모듈화는 HTTP  요청수를 증가시킴 -> 웹 성능에 부정적 영향



따라서, 기능 단위로 모듈화된 여러 파일들을 하나로 합치고 이 하나의 파일을 브라우저가 실행하는 것이 

여러 파일을 각각 호출하는 것과 동일한 결과를 만들 수 있다면 

**파일 병합으로 HTTP 요청수를 줄일 수 있다.**



책 속의 예시 이미지를 참고하면, 병합 이전 6개의 CSS파일 로딩은 0.6초 -> 이후 0.45초로 감소



### 3.1.2 인라인 이미지

HTML 파일의 CSS 안에 해시 정보를 통해 웹 페이지 배경 이미지 파일을 삽입한다.

이 방식은 HTML파일의 바이트 크기가 소폭 증가.

그러나 이미지 파일을 따로 호출하여 해당 크기만큼 파일을 받아오는 전통적인 방식과 비교하면 **전체 로딩 시간이 감소** = 인라인 이미지 라고 부름



이 방식은, 웹 페이지 안에 이미지를 포함하는 경우 별도의 이미지 파일이 존재하지 않기에 인터넷이나 브라우저에 캐시할 수 없다. HTML이 캐시되어야 동시에 캐시할 수 있음. 그러므로 전반적인 성능 개선 여부를 확인한 후 선택 사용해야함. 



- 파일 병합 : HTTP 요청 수를 줄이는 것은 물론, 인터넷상 프록시나 브라우저에 캐시될 확률을 좀 더 높인다. 

원본 파일이 존재하는 웹 서버에서 아무리 빠른 속도로 응답이 온다고 해도, 사용자의 위치의 캐시 서버나 사용자의 기기에 캐시된 콘텐츠를 사용하는게 성능면에서 훨씬 빠르다.

### 3.1.3 CSS 스프라이트

CSS 스프라이트란, 여러개의 이미지를 하나의 이미지 파일로 결합해 필요한 이미지가 위치하는 픽셀 좌표 정보를 사용하는 방식이다. 아이콘, 버튼 등 작은이미지에 유용

예시) background 이미지에 url로 사용

```
.sprite_face {
background: url(‘imgs/sprites_image.png’);
background-position: 0 -64px;
width: 50px;
height: 50px;
float:left;
transition: all .2s ease-in-out;
}
```



## 3.2 콘텐츠 파일 크기 줄이기

다운로드 시간을 줄이자

### 3.2.1 스크립트 파일 압축 전달

메일을 보낼때 zip파일로 압축해서 전송하는 것처럼,

각 웹 서버가 지원하는 방식으로 스크립트 형태 콘텐츠를 압축해 클라이언트에게 더 작은 크기로 내려주고, 

이를 다운로드한 클라이언트가 압축을 해제하여 원래 콘텐츠를 사용한다면 다운로드 속도가 더 빨라짐

압축 방식을 선택해야함. 만약 클라이언트가 지원하지 않는 압축 방식을 사용해 파일을 내려주면 클라이언트는 이를 해제할 수 없기 때문.



HTTP 프로토콜은 Accept-Encoding, Content-Encoding 헤더를 사용하여 이러한 압축 방식의 정보교환을 지원함.



브라우저가 서버에 콘텐츠를 요청하면서, 자신이 지원하는 압축 알고리즘을 HTTP request header에 나열해서 알려줌 (= 어떤 방식으로 압축해제할 수 있는지 고지함)

그러면 서버는, 그 중 자신이 지원하는 알고리즘을 택일하여 HTTP response header로 알려줌.



이 때 사용하는 것이 request header의 경우 Accept-Encoding이다

response header는 Content-Encoding



```
예시
// 클라이언트의 요청 헤더 브라우저는 gzip, deflate, sdch 압축 방식을 지원함
Accept-Encoding: gzip, deflate, sdch
//웹 서버의 응답 헤더 클라이언트가 지원하는 압축 방식 중 gzip을 사용할 것을 명시함
Content-Encoding: gzip
```

-  gzip :  UNIX 운영체제에서 일반적으로 사용하는 LZ77 파일 압축 라이브러리를 사용합니다.  32비트 CRC로 정상 압축 여부를 검사합니다.

- deflate : zlib라는 파일 압축 라이브러리를 사용합니다. RFC 1951에 정의된 압축 방식입니다
-  sdch(Shared Dictionary Compression over HTTP) : 구글이 개발한 HTTP 상의 압축 방식이며 주
  로 크롬 브라우저에서 사용합니다.

### 3.2.2 스크립트 파일 최소화

스크립트 파일에서, 실제 로직에 아무런 영향을 주지 않는 주석, 개행문자 등을 제거하여 전반적인 파일 크기를 줄이는 방식이다.

Minify 사이트



개발 서버와 운영 서버를 분리하는 방법을 많이 사용한다.



### 3.2.3 이미지 파일 압축

이미지 파일은 파일정보를 메타데이터에 포함해 저장함

tiny png 서비스 - 손실 압축 방식으로 이미지 파일 압축



### 3.2.4 브라우저가 선호하는 이미지 포맷 사용

자사 브라우저가 동일 품질의 이미지 크기를 더욱 줄일 수 있는 이미지 포맷을 개발

=WebP(Google)와  JPEG XR(MS)





### 3.2.5 큰 파일은 작게 나누어 전송

대용량 파일 전송의 예

고화질 이미지, 매우 긴 문서, 게임 패치 파일 등

파일의 일부분을 순서대로 다운로드하는 **부분 요청 응답 방식**을 사용



웹 서버에 특정 부분 파일 전달을 지원하는 기능이 있을 때만 사용가능

request header를 통해 확인

Accectp-Ranges, Content-Length, Content-Range 등

## 3.3 캐시 최적화 하기

캐시 : 자주 사용되는 콘텐츠나 특정 데이터 등을 임의의 저장소에 복제해두고 재사용하는 방식을 의미

원래 데이터 위치에 접근하는 시간보다 짧음. 시스템의 리소스를 절약가능



인터넷 캐시 : 캐시 영역에 미리 데이터를 복사해두는 push 방식 / 실제 요청이 있을 때만 캐시에 저장하는 pull 방식



### 3.3.1 인터넷 캐시 사용

인터넷상에서 자주 요청되는 콘텐츠를 캐시하는 것은 **속도와 인프라 보호** 차원에서 중요하다. 프록시 서버가 담당함.

서버 대신 클라이언트의 자원 요청에 응답해준다.

콘텐츠 소비자와 제공자 사이의 인터넷 구간이 멀 때 구간의 중간 정도에 HW or SW 방식으로 프록시를 설치해 사용함

서버와 클라이언트 사이에서 통신을 대신하는 기능 자체를 프록시, 

중계 기능을 수행하는 서버를 프록시 서버라고 함. 사용자가 많은 지역에 여러곳을 선택하여 설치함

1. 사용자 부근의 프록시 서버의 응답속도가 원래 서버의 응답속도보다 빠름
2. 원본 서버로 몰릴 수 있는 인터넷 트래픽을 프록시 서버로 분산해 원본 서버의 자원을 절약함



### 3.3.2 브라우저 캐시 사용

프록시 = 클라이언트와 서버 중간에 위치한 인터넷상의 캐시

브라우저 캐시  = 클라이언트 위치의 캐시



![image](https://user-images.githubusercontent.com/48556400/147093935-adf1e4e3-823f-45b6-95cb-69da9aaad97b.png)

얼마나 긴 시간동안 캐시해도 되는지 정책이 결정되면 

웹서버는 Cache-Control request header를 통해 설정 내용을 클라이언트에 전달함

## 3.4 CDN 사용하기

CDN : 인터넷상에서 생산,소비되는 웹 콘텐츠를 사용자에게 빠르게 전달하기 위해 **캐시 서버** 혹은 **에지 서버**라 불리는 **대용량 인터넷 캐시 영역**에 콘텐츠를 저장해 사용하는 네트워크 방식

여러 노드를 가진 네트워크에 콘텐츠를 저장하여 제공하는 프록시의 일종

원본 서버라 불리는 콘텐츠 서버와 사용자 사이에서 중재자 역할을 함





